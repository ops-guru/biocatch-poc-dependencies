name: Helm Package and Index

on:
  push:
    paths:
      - 'helm/**'

jobs:
  helm_package_and_index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Install Helm
        run: |
          wget https://get.helm.sh/helm-v3.8.0-linux-amd64.tar.gz
          tar -zxvf helm-v3.8.0-linux-amd64.tar.gz
          sudo mv linux-amd64/helm /usr/local/bin/helm
          helm version

      - name: Package Helm Library Templates
        run: |
          for i in helm/templates/*/ ; do
            helm package "$i" -d helm/packages/
          done

      - name: Helm Update Charts Dependencies
        run:
          for i in helm/charts/*/ ; do
            helm dependency update "$i" 
          done

      - name: Package Helm Charts Templates
        run: |
          for i in helm/charts/*/ ; do
            helm package "$i" -d helm/packages/
          done
          
      - name: Create Helm Repository Index
        run: |
          helm repo index helm/packages/

      - name: Upload index.yaml
        uses: actions/upload-artifact@v2
        with:
          name: index.yaml
          path: helm/packages/index.yaml

      - name: Upload Packaged Charts
        uses: actions/upload-artifact@v2
        with:
          name: packaged-charts
          path: helm/packages/*.tgz